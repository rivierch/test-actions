# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Merge Release

on:
  pull_request:
    branches: [ release/* ]
    types:
      [closed]

jobs:
  UpdateVersion:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Update Version Number
      run: |
        git config --global user.email "${GITHUB_ACTOR}@moodys.com"
        git config --global user.name "${GITHUB_ACTOR}"
        inc=`git describe --tags  --abbrev=0 | grep -Eo '[0-9]+$'`
        version_number="`git branch --show-current | grep -Eo '[0-9\.]+$'`.RC`echo $((inc+1))`"
        # update version file
        cd rhub_core/rhub_core/version
        echo \# file generated by start release github action | tee branch_version.py
        echo __version__=\"$version_number\" | tee -a branch_version.py
        git add branch_version.py
        git commit -m "Create new release candidate $version_number"
        echo create new tag $version_number
        git tag -a release/$version_number -m "new release $version_number"
        git push --follow-tags
